<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Love Calculator</title>
  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      cursor: url('https://cdn.pixabay.com/photo/2022/07/26/16/00/cursor-7346881_960_720.png'), auto;
    }

    .container {
      text-align: center;
      padding: 20px;
      border-radius: 10px;
      background-color: #1f1f1f;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      width: 100%;
      max-width: 400px;
    }

    h2 {
      color: #ff007f;
      font-size: 36px;
    }

    input {
      background-color: #333;
      color: white;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #444;
      border-radius: 5px;
      width: 80%;
      font-size: 16px;
    }

    button {
      background-color: #ff007f;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      cursor: pointer;
    }

    button:hover {
      background-color: #ff3385;
    }

    #result {
      margin-top: 20px;
      font-size: 20px;
      color: #00ffb3;
    }

    #result.error {
      color: red;
    }

    .cooldown-message {
      margin-top: 10px;
      color: #ff5722;
    }

    .footer {
      margin-top: 20px;
      font-size: 14px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Love Calculator ðŸ’–</h2>
    <input id="girlName" placeholder="Enter girl's name" oninput="debounceSearch()"><br><br>
    <input id="boyName" placeholder="Enter boy's name" oninput="debounceSearch()"><br><br>
    <button onclick="calculateLove()">Calculate Love</button>

    <p id="result"></p>
    <p id="cooldownMessage" class="cooldown-message"></p>

    <div class="footer">
      <p>Made with ðŸ’– by Love Finder</p>
    </div>
  </div>

  <script type="module">
    // Import Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, push, get, child } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCDG2lZpLgJ2PG2WX3TfVGI3HcnzcukC7s",
      authDomain: "lovefinder-193df.firebaseapp.com",
      databaseURL: "https://lovefinder-193df-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "lovefinder-193df",
      storageBucket: "lovefinder-193df.appspot.com",
      messagingSenderId: "572820717197",
      appId: "1:572820717197:web:e67be9eaf6087cda4cacc4",
      measurementId: "G-CHBWSKLVTS"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let lastSubmissionTime = 0;
    const submissionCooldown = 30000; // 30 seconds cooldown
    let debounceTimer;

    // Function to handle debouncing
    function debounceSearch() {
      clearTimeout(debounceTimer);

      debounceTimer = setTimeout(() => {
        calculateLove();
      }, 500); // 500ms delay before calling calculateLove function
    }

    // Check localStorage for previous result
    function checkLocalStorage(girl, boy) {
      const key = `${girl}-${boy}`;
      const storedResult = localStorage.getItem(key);
      
      if (storedResult) {
        const result = JSON.parse(storedResult);
        document.getElementById("result").innerText = 
          `Love score between ${result.girl} and ${result.boy} is ${result.score}% (from local cache)`;
        return true;
      }
      return false;
    }

    // Save to localStorage
    function saveToLocalStorage(girl, boy, score) {
      const key = `${girl}-${boy}`;
      const result = {
        girl,
        boy,
        score,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem(key, JSON.stringify(result));
    }

    // Check for duplicate and save to Firebase
    async function checkForDuplicateAndSave(girl, boy, score) {
      const loveDataRef = ref(db, "loveData");
      const snapshot = await get(loveDataRef);
      
      let duplicateFound = false;
      if (snapshot.exists()) {
        snapshot.forEach(entry => {
          const data = entry.val();
          // Check both combinations (girl, boy) or (boy, girl)
          if (
            (data.girlName.toLowerCase() === girl.toLowerCase() && data.boyName.toLowerCase() === boy.toLowerCase()) ||
            (data.girlName.toLowerCase() === boy.toLowerCase() && data.boyName.toLowerCase() === girl.toLowerCase())
          ) {
            duplicateFound = true; // Found a duplicate
          }
        });
      }

      if (duplicateFound) {
        document.getElementById("result").innerText = "This love match has already been calculated.";
        return; // Skip saving the data
      }

      const dataRef = ref(db, "loveData");
      push(dataRef, {
        girlName: girl,
        boyName: boy,
        score: score,
        timestamp: new Date().toISOString()
      });

      saveToLocalStorage(girl, boy, score);
      document.getElementById("result").innerText = 
        `Love score between ${girl} and ${boy} is ${score}%`;
    }

    // Calculate love and save to Firebase
    async function calculateLove() {
      const girl = document.getElementById("girlName").value.trim();
      const boy = document.getElementById("boyName").value.trim();

      if (!girl || !boy) {
        document.getElementById("result").innerText = "Please enter both names.";
        return;
      }

      if (girl.toLowerCase() === boy.toLowerCase()) {
        document.getElementById("result").innerText = "Girl's and Boy's name cannot be the same!";
        return;
      }

      // Check for cooldown
      const currentTime = new Date().getTime();
      if (currentTime - lastSubmissionTime < submissionCooldown) {
        document.getElementById("cooldownMessage").innerText = "Please wait before submitting again.";
        return;
      }

      lastSubmissionTime = currentTime;
      document.getElementById("cooldownMessage").innerText = "";

      if (checkLocalStorage(girl, boy)) {
        return; // If found in localStorage, no need to query Firebase
      }

      let score = (girl.toLowerCase() === "tanvi" && boy.toLowerCase() === "anurag") 
        ? 100 
        : Math.floor(Math.random() * 100) + 1;

      checkForDuplicateAndSave(girl, boy, score);
    }
  </script>
</body>
</html>
